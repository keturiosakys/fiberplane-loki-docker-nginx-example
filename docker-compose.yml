version: "3.4"

services:
    my-nginx-service:
        image: nginx
        container_name: my-nginx-service
        ports:
            - 8000:80
        environment:
            - FOO=bar
        logging:
            driver: loki
            options:
                loki-url: http://localhost:3100/loki/api/v1/push
                loki-external-labels: job=dockerlogs,owner=fiberplane,environment=development

    logger-app:
        image: ctovena/logger:0.12
        container_name: logger
        logging:
            driver: loki
            options:
                loki-url: http://localhost:3100/loki/api/v1/push
                loki-external-labels: job=dockerlogs,owner=fiberplane,environment=development

    loki:
        image: grafana/loki:2.0.0
        container_name: loki
        volumes:
            - ./config/loki.yaml:/etc/config/loki.yaml
        entrypoint:
            - /usr/bin/loki
            - -config.file=/etc/config/loki.yaml
        ports:
            - "3200:3200"

    fiberplane-proxy:
        image: fiberplane/proxy:v1
        container_name: fiberplane-proxy
        volumes:
            - "./config/data_sources.yaml:/app/data_sources.yaml"
        command: "--auth-token=${PROXY_API_TOKEN}"
